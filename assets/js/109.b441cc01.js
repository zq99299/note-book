(window["webpackJsonp"] = window["webpackJsonp"] || []).push([[109],{

/***/ "./docs/back-end-storage/02/03.md":
/*!****************************************!*\
  !*** ./docs/back-end-storage/02/03.md ***!
  \****************************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony import */ var _03_md_vue_type_template_id_4ddb178b___WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./03.md?vue&type=template&id=4ddb178b& */ "./docs/back-end-storage/02/03.md?vue&type=template&id=4ddb178b&");
/* harmony import */ var _node_modules_vue_loader_lib_runtime_componentNormalizer_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../../node_modules/vue-loader/lib/runtime/componentNormalizer.js */ "./node_modules/vue-loader/lib/runtime/componentNormalizer.js");

var script = {}


/* normalize component */

var component = Object(_node_modules_vue_loader_lib_runtime_componentNormalizer_js__WEBPACK_IMPORTED_MODULE_1__["default"])(
  script,
  _03_md_vue_type_template_id_4ddb178b___WEBPACK_IMPORTED_MODULE_0__["render"],
  _03_md_vue_type_template_id_4ddb178b___WEBPACK_IMPORTED_MODULE_0__["staticRenderFns"],
  false,
  null,
  null,
  null
  
)

/* harmony default export */ __webpack_exports__["default"] = (component.exports);

/***/ }),

/***/ "./docs/back-end-storage/02/03.md?vue&type=template&id=4ddb178b&":
/*!***********************************************************************!*\
  !*** ./docs/back-end-storage/02/03.md?vue&type=template&id=4ddb178b& ***!
  \***********************************************************************/
/*! exports provided: render, staticRenderFns */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony import */ var _node_modules_cache_loader_dist_cjs_js_cacheDirectory_node_modules_vuepress_core_node_modules_cache_vuepress_cacheIdentifier_2e9acca5_vue_loader_template_node_modules_vue_loader_lib_loaders_templateLoader_js_vue_loader_options_node_modules_cache_loader_dist_cjs_js_ref_1_0_node_modules_vue_loader_lib_index_js_ref_1_1_node_modules_vuepress_markdown_loader_index_js_ref_1_2_03_md_vue_type_template_id_4ddb178b___WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! -!../../../node_modules/cache-loader/dist/cjs.js?{"cacheDirectory":"node_modules/@vuepress/core/node_modules/.cache/vuepress","cacheIdentifier":"2e9acca5-vue-loader-template"}!../../../node_modules/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!../../../node_modules/cache-loader/dist/cjs.js??ref--1-0!../../../node_modules/vue-loader/lib??ref--1-1!../../../node_modules/@vuepress/markdown-loader??ref--1-2!./03.md?vue&type=template&id=4ddb178b& */ "./node_modules/cache-loader/dist/cjs.js?{\"cacheDirectory\":\"node_modules/@vuepress/core/node_modules/.cache/vuepress\",\"cacheIdentifier\":\"2e9acca5-vue-loader-template\"}!./node_modules/vue-loader/lib/loaders/templateLoader.js?!./node_modules/cache-loader/dist/cjs.js?!./node_modules/vue-loader/lib/index.js?!./node_modules/@vuepress/markdown-loader/index.js?!./docs/back-end-storage/02/03.md?vue&type=template&id=4ddb178b&");
/* harmony reexport (safe) */ __webpack_require__.d(__webpack_exports__, "render", function() { return _node_modules_cache_loader_dist_cjs_js_cacheDirectory_node_modules_vuepress_core_node_modules_cache_vuepress_cacheIdentifier_2e9acca5_vue_loader_template_node_modules_vue_loader_lib_loaders_templateLoader_js_vue_loader_options_node_modules_cache_loader_dist_cjs_js_ref_1_0_node_modules_vue_loader_lib_index_js_ref_1_1_node_modules_vuepress_markdown_loader_index_js_ref_1_2_03_md_vue_type_template_id_4ddb178b___WEBPACK_IMPORTED_MODULE_0__["render"]; });

/* harmony reexport (safe) */ __webpack_require__.d(__webpack_exports__, "staticRenderFns", function() { return _node_modules_cache_loader_dist_cjs_js_cacheDirectory_node_modules_vuepress_core_node_modules_cache_vuepress_cacheIdentifier_2e9acca5_vue_loader_template_node_modules_vue_loader_lib_loaders_templateLoader_js_vue_loader_options_node_modules_cache_loader_dist_cjs_js_ref_1_0_node_modules_vue_loader_lib_index_js_ref_1_1_node_modules_vuepress_markdown_loader_index_js_ref_1_2_03_md_vue_type_template_id_4ddb178b___WEBPACK_IMPORTED_MODULE_0__["staticRenderFns"]; });



/***/ }),

/***/ "./docs/back-end-storage/02/assets/41bb301944e65e1585b238d26717e5e6.png":
/*!******************************************************************************!*\
  !*** ./docs/back-end-storage/02/assets/41bb301944e65e1585b238d26717e5e6.png ***!
  \******************************************************************************/
/*! no static exports found */
/***/ (function(module, exports, __webpack_require__) {

module.exports = __webpack_require__.p + "assets/img/41bb301944e65e1585b238d26717e5e6.41bb3019.png";

/***/ }),

/***/ "./docs/back-end-storage/02/assets/651cf39892c7ab057b0d7b3c6a93d85b.png":
/*!******************************************************************************!*\
  !*** ./docs/back-end-storage/02/assets/651cf39892c7ab057b0d7b3c6a93d85b.png ***!
  \******************************************************************************/
/*! no static exports found */
/***/ (function(module, exports, __webpack_require__) {

module.exports = __webpack_require__.p + "assets/img/651cf39892c7ab057b0d7b3c6a93d85b.651cf398.png";

/***/ }),

/***/ "./node_modules/cache-loader/dist/cjs.js?{\"cacheDirectory\":\"node_modules/@vuepress/core/node_modules/.cache/vuepress\",\"cacheIdentifier\":\"2e9acca5-vue-loader-template\"}!./node_modules/vue-loader/lib/loaders/templateLoader.js?!./node_modules/cache-loader/dist/cjs.js?!./node_modules/vue-loader/lib/index.js?!./node_modules/@vuepress/markdown-loader/index.js?!./docs/back-end-storage/02/03.md?vue&type=template&id=4ddb178b&":
/*!***********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************!*\
  !*** ./node_modules/cache-loader/dist/cjs.js?{"cacheDirectory":"node_modules/@vuepress/core/node_modules/.cache/vuepress","cacheIdentifier":"2e9acca5-vue-loader-template"}!./node_modules/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!./node_modules/cache-loader/dist/cjs.js??ref--1-0!./node_modules/vue-loader/lib??ref--1-1!./node_modules/@vuepress/markdown-loader??ref--1-2!./docs/back-end-storage/02/03.md?vue&type=template&id=4ddb178b& ***!
  \***********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
/*! exports provided: render, staticRenderFns */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "render", function() { return render; });
/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "staticRenderFns", function() { return staticRenderFns; });
var render = function () {var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c('ContentSlotsDistributor',{attrs:{"slot-key":_vm.$parent.slotKey}},[_c('h1',{attrs:{"id":"走进黑盒-sql-是如何在数据库中执行的"}},[_c('a',{staticClass:"header-anchor",attrs:{"href":"#走进黑盒-sql-是如何在数据库中执行的"}},[_vm._v("#")]),_vm._v(" 走进黑盒：SQL 是如何在数据库中执行的？")]),_vm._v(" "),_c('p',[_vm._v("上一节课我们讲了怎么来避免写出慢 SQL，课后我给你留了一道思考题：在下面这两个 SQL 中，为什么第一个 SQL 在执行的时候无法命中索引呢？")]),_vm._v(" "),_c('div',{staticClass:"language-sql line-numbers-mode"},[_c('pre',{pre:true,attrs:{"class":"language-sql"}},[_c('code',[_c('span',{pre:true,attrs:{"class":"token keyword"}},[_vm._v("SELECT")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("*")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token keyword"}},[_vm._v("FROM")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token keyword"}},[_vm._v("user")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token keyword"}},[_vm._v("WHERE")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token keyword"}},[_vm._v("left")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("department_code"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(",")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("5")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token string"}},[_vm._v("'00028'")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(";")]),_vm._v("\n"),_c('span',{pre:true,attrs:{"class":"token keyword"}},[_vm._v("SELECT")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("*")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token keyword"}},[_vm._v("FROM")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token keyword"}},[_vm._v("user")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token keyword"}},[_vm._v("WHERE")]),_vm._v(" department_code "),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("LIKE")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token string"}},[_vm._v("'00028%'")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(";")]),_vm._v("\n")])]),_vm._v(" "),_c('div',{staticClass:"line-numbers-wrapper"},[_c('span',{staticClass:"line-number"},[_vm._v("1")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("2")]),_c('br')])]),_c('p',[_vm._v("原因是，这个 SQL 的 WHERE 条件中对 department_code 这个列做了一个 left 截取的计算，对于表中的每一条数据，都得先做截取计算，然后判断截取后的值，所以不得不做全表扫描。你在写 SQL 的时候，尽量不要在 WEHER 条件中，对列做任何计算。")]),_vm._v(" "),_c('p',[_vm._v("到这里这个问题就结束了么？那我再给你提一个问题，这两个 SQL 中的 WHERE 条件，**虽然写法不一样，但它俩的语义不就是一样的么？**是不是都可以解释成：department_code 这一列前 5 个字符是 00028？从语义上来说，没有任何不同是吧？所以，它们的查询结果也是完全一样的。那凭什么第一条 SQL 就得全表扫描，第二条 SQL 就可以命中索引？")]),_vm._v(" "),_c('p',[_vm._v("对于我们日常编写 SQL 的一些优化方法，比如说我刚刚讲的：「尽量不要在 WEHER 条件中，对列做计算」，很多同学只是知道这些方法，"),_c('strong',[_vm._v("但是却不知道，为什么按照这些方法写出来的 SQL 就快？")])]),_vm._v(" "),_c('p',[_vm._v("要回答这些问题，"),_c('strong',[_vm._v("需要了解一些数据库的实现原理")]),_vm._v("。对很多开发者来说，数据库就是个黑盒子，你会写 SQL，会用数据库，但不知道盒子里面到底是怎么一回事儿，这样你只能机械地去记住别人告诉你的那些优化规则，却不知道为什么要遵循这些规则，也就谈不上灵活运用。")]),_vm._v(" "),_c('p',[_vm._v("今天这节课，我带你一起打开盒子看一看，SQL 是如何在数据库中执行的。")]),_vm._v(" "),_c('p',[_vm._v("数据库是一个非常非常复杂的软件系统，我会尽量忽略复杂的细节，用简单的方式把最主要的原理讲给你。即使这样，这节课的内容仍然会非常的硬核，你要有所准备。")]),_vm._v(" "),_c('p',[_vm._v("数据库的服务端，可以划分为 "),_c('strong',[_vm._v("执行器 (Execution Engine)")]),_vm._v("  和 "),_c('strong',[_vm._v("存储引擎 (Storage Engine)")]),_vm._v("  两部分。执行器负责解析 SQL 执行查询，存储引擎负责保存数据。")]),_vm._v(" "),_c('h2',{attrs:{"id":"sql-是如何在执行器中执行的"}},[_c('a',{staticClass:"header-anchor",attrs:{"href":"#sql-是如何在执行器中执行的"}},[_vm._v("#")]),_vm._v(" SQL 是如何在执行器中执行的？")]),_vm._v(" "),_c('p',[_vm._v("我们通过一个例子来看一下，执行器是如何来解析执行一条 SQL 的。")]),_vm._v(" "),_c('div',{staticClass:"language-sql line-numbers-mode"},[_c('pre',{pre:true,attrs:{"class":"language-sql"}},[_c('code',[_c('span',{pre:true,attrs:{"class":"token keyword"}},[_vm._v("SELECT")]),_vm._v(" u"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(".")]),_vm._v("id "),_c('span',{pre:true,attrs:{"class":"token keyword"}},[_vm._v("AS")]),_vm._v(" user_id"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(",")]),_vm._v(" u"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(".")]),_vm._v("name "),_c('span',{pre:true,attrs:{"class":"token keyword"}},[_vm._v("AS")]),_vm._v(" user_name"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(",")]),_vm._v(" o"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(".")]),_vm._v("id "),_c('span',{pre:true,attrs:{"class":"token keyword"}},[_vm._v("AS")]),_vm._v(" order_id\n"),_c('span',{pre:true,attrs:{"class":"token keyword"}},[_vm._v("FROM")]),_vm._v(" users u "),_c('span',{pre:true,attrs:{"class":"token keyword"}},[_vm._v("INNER")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token keyword"}},[_vm._v("JOIN")]),_vm._v(" orders o "),_c('span',{pre:true,attrs:{"class":"token keyword"}},[_vm._v("ON")]),_vm._v(" u"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(".")]),_vm._v("id "),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_vm._v(" o"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(".")]),_vm._v("user_id\n"),_c('span',{pre:true,attrs:{"class":"token keyword"}},[_vm._v("WHERE")]),_vm._v(" u"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(".")]),_vm._v("id "),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v(">")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("50")]),_vm._v("\n")])]),_vm._v(" "),_c('div',{staticClass:"line-numbers-wrapper"},[_c('span',{staticClass:"line-number"},[_vm._v("1")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("2")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("3")]),_c('br')])]),_c('p',[_vm._v("这个 SQL 语义是，查询用户 ID 大于 50 的用户的所有订单，这是很简单的一个联查，需要查询 users 和 orders 两张表，WHERE 条件就是，用户 ID 大于 50。")]),_vm._v(" "),_c('p',[_vm._v("数据库收到查询请求后，"),_c('strong',[_vm._v("需要先解析 SQL 语句")]),_vm._v("，把这一串文本解析成便于程序处理的结构化数据，这就是一个 "),_c('strong',[_vm._v("通用的语法解析过程")]),_vm._v(" 。跟编程语言的编译器编译时，解析源代码的过程是完全一样的。如果是计算机专业的同学，你上过的《编译原理》这门课，其中很大的篇幅是在讲解这一块儿。没学过《"),_c('strong',[_vm._v("编译原理")]),_vm._v("》的同学也不用担心，你暂时先不用搞清楚，SQL 文本是怎么转换成结构化数据的，不妨碍你学习和理解这节课下面的内容。")]),_vm._v(" "),_c('p',[_vm._v("转换后的结构化数据，就是一棵树，这个树的名字叫 "),_c('strong',[_vm._v("抽象语法树（AST，Abstract Syntax Tree）")]),_vm._v("。上面这个 SQL，它的 AST 大概是这样的：")]),_vm._v(" "),_c('p',[_c('img',{attrs:{"src":__webpack_require__(/*! ./assets/651cf39892c7ab057b0d7b3c6a93d85b.png */ "./docs/back-end-storage/02/assets/651cf39892c7ab057b0d7b3c6a93d85b.png"),"alt":"img"}})]),_vm._v(" "),_c('p',[_vm._v("这个树太复杂，我只画了主要的部分，你大致看一下，能理解这个 SQL 的语法树长什么样就行了。执行器解析这个 AST 之后，会生成一个 "),_c('strong',[_vm._v("逻辑执行计划")]),_vm._v("。所谓的执行计划，可以简单理解为如何一步一步地执行查询和计算，最终得到执行结果的一个分步骤的计划。这个逻辑执行计划是这样的：")]),_vm._v(" "),_c('div',{staticClass:"language-java line-numbers-mode"},[_c('pre',{pre:true,attrs:{"class":"language-java"}},[_c('code',[_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("LogicalProject")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("user_id"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("$"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("0")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(",")]),_vm._v(" user_name"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("$"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("1")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(",")]),_vm._v(" order_id"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("$"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("5")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("\n    "),_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("LogicalFilter")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("condition"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("$"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("0")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v(">")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("50")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("\n        "),_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("LogicalJoin")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("condition"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("$"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("0")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("==")]),_vm._v(" $"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("6")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(",")]),_vm._v(" joinType"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("inner"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("\n            "),_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("LogicalTableScan")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("table"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("users"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("\n            "),_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("LogicalTableScan")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("table"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("orders"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("\n")])]),_vm._v(" "),_c('div',{staticClass:"line-numbers-wrapper"},[_c('span',{staticClass:"line-number"},[_vm._v("1")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("2")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("3")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("4")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("5")]),_c('br')])]),_c('p',[_vm._v("和 SQL、AST 不同的是，这个逻辑执行计划已经很像可以执行的程序代码了。你看上面这个执行计划，很像我们编程语言的函数调用栈，外层的方法调用内层的方法。所以，要理解这个执行计划，得 "),_c('strong',[_vm._v("从内往外看")]),_vm._v("。")]),_vm._v(" "),_c('ol',[_c('li',[_c('p',[_vm._v("最内层的 2 个 LogicalTableScan 的含义是，把 USERS 和 ORDERS 这两个表的数据都读出来。")])]),_vm._v(" "),_c('li',[_c('p',[_vm._v("然后拿这两个表所有数据做一个 LogicalJoin，JOIN 的条件就是第 0 列 (u.id) 等于第 6 列 (o.user_id)。")])]),_vm._v(" "),_c('li',[_c('p',[_vm._v("然后再执行一个 LogicalFilter 过滤器，过滤条件是第 0 列 (u.id) 大于 5。")])]),_vm._v(" "),_c('li',[_c('p',[_vm._v("最后，做一个 LogicalProject 投影，只保留第 "),_c('code',[_vm._v("0(user_id)、1(user_name)、5(order_id)")]),_vm._v("  三列。这里 「投影 (Project)」的意思是，把不需要的列过滤掉。")])])]),_vm._v(" "),_c('p',[_vm._v("把这个逻辑执行计划翻译成代码，然后按照顺序执行，就可以正确地查询出数据了。但是，按照上面那个执行计划，需要执行 2 个全表扫描，然后再把 2 个表的所有数据做一个 JOIN 操作，这个性能是非常非常差的。")]),_vm._v(" "),_c('p',[_vm._v("我们可以简单算一下，如果，user 表有 1,000 条数据，订单表里面有 10,000 条数据，这个 JOIN 操作需要遍历的行数就是 1,000 x 10,000 = 10,000,000 行。可见，这种从 SQL 的 AST 直译过来的逻辑执行计划，一般性能都非常差，所以，需要对执行计划进行优化。")]),_vm._v(" "),_c('div',{staticClass:"language-java line-numbers-mode"},[_c('pre',{pre:true,attrs:{"class":"language-java"}},[_c('code',[_vm._v("\n"),_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("LogicalProject")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("user_id"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("$"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("0")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(",")]),_vm._v(" user_name"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("$"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("1")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(",")]),_vm._v(" order_id"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("$"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("5")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("\n    "),_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("LogicalJoin")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("condition"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("$"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("0")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("==")]),_vm._v(" $"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("6")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(",")]),_vm._v(" joinType"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("inner"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("\n        "),_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("LogicalProject")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("id"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("$"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("0")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(",")]),_vm._v(" name"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("$"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("1")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("              "),_c('span',{pre:true,attrs:{"class":"token comment"}},[_vm._v("// 尽早执行投影")]),_vm._v("\n            "),_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("LogicalFilter")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("condition"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("$"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("0")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v(">")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("50")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("          "),_c('span',{pre:true,attrs:{"class":"token comment"}},[_vm._v("// 尽早执行过滤")]),_vm._v("\n                "),_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("LogicalTableScan")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("table"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("users"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("\n        "),_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("LogicalProject")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("id"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("$"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("0")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(",")]),_vm._v(" user_id"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("$"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("1")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("           "),_c('span',{pre:true,attrs:{"class":"token comment"}},[_vm._v("// 尽早执行投影")]),_vm._v("\n            "),_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("LogicalTableScan")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("table"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("orders"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("\n")])]),_vm._v(" "),_c('div',{staticClass:"line-numbers-wrapper"},[_c('span',{staticClass:"line-number"},[_vm._v("1")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("2")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("3")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("4")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("5")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("6")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("7")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("8")]),_c('br')])]),_c('p',[_vm._v("对比原始的逻辑执行计划，这里我们做了两点简单的优化：")]),_vm._v(" "),_c('ol',[_c('li',[_c('p',[_vm._v("尽早地执行投影，去除不需要的列；")])]),_vm._v(" "),_c('li',[_c('p',[_vm._v("尽早地执行数据过滤，去除不需要的行。")])])]),_vm._v(" "),_c('p',[_vm._v("这样，就  "),_c('strong',[_vm._v("可以在做 JOIN 之前，把需要 JOIN 的数据尽量减少")]),_vm._v("。这个优化后的执行计划，显然会比原始的执行计划快很多。")]),_vm._v(" "),_c('p',[_vm._v("到这里，"),_c('strong',[_vm._v("执行器只是在逻辑层面分析 SQL")]),_vm._v("，优化查询的执行逻辑，我们执行计划中操作的数据，仍然是表、行和列。在数据库中，表、行、列都是逻辑概念，所以，这个执行计划叫 "),_c('strong',[_vm._v("逻辑执行计划")]),_vm._v("。执行查询接下来的部分，就需要涉及到数据库的物理存储结构了。")]),_vm._v(" "),_c('h2',{attrs:{"id":"sql-是如何在存储引擎中执行的"}},[_c('a',{staticClass:"header-anchor",attrs:{"href":"#sql-是如何在存储引擎中执行的"}},[_vm._v("#")]),_vm._v(" SQL 是如何在存储引擎中执行的？")]),_vm._v(" "),_c('p',[_vm._v("数据真正存储的时候，无论在磁盘里，还是在内存中，都没法直接存储这种带有行列的二维表。数据库中的二维表，实际上是怎么存储的呢？这就是存储引擎负责解决的问题，"),_c('strong',[_vm._v("存储引擎主要功能就是把逻辑的表行列，用合适的物理存储结构保存到文件中")]),_vm._v("。不同的数据库，它们的物理存储结构是完全不一样的，这也是各种数据库之间巨大性能差距的根本原因。")]),_vm._v(" "),_c('p',[_vm._v("我们还是以 MySQL 为例来说一下它的物理存储结构。MySQL 非常牛的一点是，它在设计层面对存储引擎做了抽象，它的存储引擎是可以替换的。它默认的存储引擎是 InnoDB，在 InnoDB 中，数据表的物理存储结构是以主键为关键字的 "),_c('code',[_vm._v("B+")]),_vm._v(" 树，每一行数据直接就保存在 "),_c('code',[_vm._v("B+")]),_vm._v("  树的叶子节点上。比如，上面的订单表组织成 "),_c('code',[_vm._v("B+")]),_vm._v(" 树，是这个样的：")]),_vm._v(" "),_c('p',[_c('img',{attrs:{"src":__webpack_require__(/*! ./assets/41bb301944e65e1585b238d26717e5e6.png */ "./docs/back-end-storage/02/assets/41bb301944e65e1585b238d26717e5e6.png"),"alt":"img"}})]),_vm._v(" "),_c('p',[_vm._v("这个树以订单表的主键 "),_c('code',[_vm._v("orders.id")]),_vm._v(" 为关键字组织，其中 "),_c('code',[_vm._v("62:[row data]")]),_vm._v("，表示的是订单号为 62 的一行订单数据。在 InnoDB 中，表的索引也是以 B+ 树的方式来存储的，和存储数据的 B+ 树的区别是，"),_c('strong',[_vm._v("在索引树中，叶子节点保存的不是行数据，而是行的主键值")]),_vm._v("。")]),_vm._v(" "),_c('p',[_vm._v("如果通过索引来检索一条记录，需要先后查询索引树和数据树这两棵树："),_c('strong',[_vm._v("先在索引树中检索到行记录的主键值，然后再用主键值去数据树中去查找这一行数据")]),_vm._v("。")]),_vm._v(" "),_c('p',[_vm._v("简单了解了存储引擎的物理存储结构之后，我们回过头来继续看 SQL 是怎么在存储引擎中继续执行的。优化后的逻辑执行计划将会被转换成物理执行计划，物理执行计划是和数据的物理存储结构相关的。还是用 InnoDB 来举例，直接将逻辑执行计划转换为物理执行计划：")]),_vm._v(" "),_c('div',{staticClass:"language-java line-numbers-mode"},[_c('pre',{pre:true,attrs:{"class":"language-java"}},[_c('code',[_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("InnodbProject")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("user_id"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("$"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("0")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(",")]),_vm._v(" user_name"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("$"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("1")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(",")]),_vm._v(" order_id"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("$"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("5")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("\n    "),_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("InnodbJoin")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("condition"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("$"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("0")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("==")]),_vm._v(" $"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("6")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(",")]),_vm._v(" joinType"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("inner"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("\n        "),_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("InnodbTreeNodesProject")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("id"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("key"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(",")]),_vm._v(" name"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("data"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("1")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("\n            "),_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("InnodbFilter")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("condition"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("key "),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v(">")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("50")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("\n                "),_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("InnodbTreeScanAll")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("tree"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("users"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("\n        "),_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("InnodbTreeNodesProject")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("id"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("key"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(",")]),_vm._v(" user_id"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("data"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("1")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("\n            "),_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("InnodbTreeScanAll")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("tree"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("orders"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("\n")])]),_vm._v(" "),_c('div',{staticClass:"line-numbers-wrapper"},[_c('span',{staticClass:"line-number"},[_vm._v("1")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("2")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("3")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("4")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("5")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("6")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("7")]),_c('br')])]),_c('p',[_vm._v("物理执行计划同样可以根据数据的 "),_c('strong',[_vm._v("物理存储结构")]),_vm._v("、"),_c('strong',[_vm._v("是否存在索引")]),_vm._v(" 以及 "),_c('strong',[_vm._v("数据多少")]),_vm._v(" 等各种因素 "),_c('strong',[_vm._v("进行优化")]),_vm._v("。这一块儿的优化规则同样是非常复杂的，比如，我们可以把对用户树的全树扫描再按照主键过滤这两个步骤，优化为对树的范围查找。")]),_vm._v(" "),_c('div',{staticClass:"language-java line-numbers-mode"},[_c('pre',{pre:true,attrs:{"class":"language-java"}},[_c('code',[_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("PhysicalProject")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("user_id"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("$"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("0")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(",")]),_vm._v(" user_name"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("$"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("1")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(",")]),_vm._v(" order_id"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("$"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("5")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("\n    "),_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("PhysicalJoin")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("condition"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("$"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("0")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("==")]),_vm._v(" $"),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("6")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(",")]),_vm._v(" joinType"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("inner"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("\n        "),_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("InnodbTreeNodesProject")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("id"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("key"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(",")]),_vm._v(" name"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("data"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("1")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("\n            "),_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("InnodbTreeRangeScan")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("tree"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("users"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(",")]),_vm._v(" range"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("key "),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v(">")]),_vm._v(" "),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("50")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("  "),_c('span',{pre:true,attrs:{"class":"token comment"}},[_vm._v("// 全树扫描再按照主键过滤，直接可以优化为对树的范围查找")]),_vm._v("\n        "),_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("InnodbTreeNodesProject")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("id"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("key"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(",")]),_vm._v(" user_id"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("data"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_c('span',{pre:true,attrs:{"class":"token number"}},[_vm._v("1")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("\n            "),_c('span',{pre:true,attrs:{"class":"token class-name"}},[_vm._v("InnodbTreeScanAll")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("(")]),_vm._v("tree"),_c('span',{pre:true,attrs:{"class":"token operator"}},[_vm._v("=")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("[")]),_vm._v("orders"),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v("]")]),_c('span',{pre:true,attrs:{"class":"token punctuation"}},[_vm._v(")")]),_vm._v("\n")])]),_vm._v(" "),_c('div',{staticClass:"line-numbers-wrapper"},[_c('span',{staticClass:"line-number"},[_vm._v("1")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("2")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("3")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("4")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("5")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("6")]),_c('br')])]),_c('p',[_vm._v("最终，按照优化后的物理执行计划，一步一步地去执行查找和计算，就可以得到 SQL 的查询结果了。")]),_vm._v(" "),_c('p',[_vm._v("理解数据库执行 SQL 的过程，以及不同存储引擎中的数据和索引的物理存储结构，对于正确使用和优化 SQL 非常有帮助。")]),_vm._v(" "),_c('p',[_vm._v("比如，我们知道了 InnoDB 的索引实现后，就很容易明白 "),_c('strong',[_vm._v("为什么主键不能太长，因为表的每个索引保存的都是主键的值，过长的主键会导致每一个索引都很大")]),_vm._v("。再比如，我们了解了执行计划的优化过程后，就很容易理解，有的时候明明有索引却不能命中的原因是，数据库在对物理执行计划优化的时候，评估发现不走索引，直接全表扫描是更优的选择。")]),_vm._v(" "),_c('p',[_vm._v("回头再来看一下这节课开头的那两条 SQL，为什么一个不能命中索引，一个能命中？原因是 InnoDB 对物理执行计划进行优化的时候，能识别 LIKE 这种过滤条件，转换为对索引树的范围查找。而对第一条 SQL 这种写法，优化规则就没那么「智能」了。")]),_vm._v(" "),_c('p',[_vm._v("它并没有识别出来，这个条件同样可以转换为对索引树的范围查找，而走了全表扫描。并不是说第一个 SQL 写的不好，而是数据库还不够智能。那现实如此，我们能做的就是尽量了解数据库的脾气秉性，按照它现有能力，尽量写出它能优化好的 SQL。")]),_vm._v(" "),_c('h2',{attrs:{"id":"小结"}},[_c('a',{staticClass:"header-anchor",attrs:{"href":"#小结"}},[_vm._v("#")]),_vm._v(" 小结")]),_vm._v(" "),_c('p',[_vm._v("一条 SQL 在数据库中执行，首先 SQL 经过语法解析成 AST，然后 AST 转换为逻辑执行计划，逻辑执行计划经过优化后，转换为物理执行计划，再经过物理执行计划优化后，按照优化后的物理执行计划执行完成数据的查询。几乎所有的数据库，都是由 "),_c('strong',[_vm._v("执行器")]),_vm._v(" 和  "),_c('strong',[_vm._v("存储引擎")]),_vm._v(" 两部分组成，执行器负责执行计算，存储引擎负责保存数据。")]),_vm._v(" "),_c('p',[_vm._v("掌握了查询的执行过程和数据库内部的组成，你才能理解那些优化 SQL 的规则，这些都有助于你更好理解数据库行为，更高效地去使用数据库。")]),_vm._v(" "),_c('p',[_vm._v("最后需要说明的一点是，今天这节课所讲的内容，不只是适用于我们用来举例的 MySQL，几乎所有支持 SQL 的数据库，无论是传统的关系型数据库、还是 NoSQL、NewSQL 这些新兴的数据库，无论是单机数据库还是分布式数据库，比如 HBase、Elasticsearch 和 SparkSQL 等等这些数据库，它们的实现原理也都符合我们今天这节课所讲的内容。")]),_vm._v(" "),_c('h2',{attrs:{"id":"思考题"}},[_c('a',{staticClass:"header-anchor",attrs:{"href":"#思考题"}},[_vm._v("#")]),_vm._v(" 思考题")]),_vm._v(" "),_c('p',[_vm._v("请你选一种你熟悉的 "),_c('strong',[_vm._v("非关系型数据库")]),_vm._v("，最好是支持 SQL 的，当然，不支持 SQL 有自己的查询语言也可以。比如说 HBase、Redis 或者 MongoDB 等等都可以，尝试分析一下查询的执行过程，对比一下它的执行器和存储引擎与 MySQL 有什么不同。")]),_vm._v(" "),_c('p',[_vm._v("答：我们拿一个分布式数据库 Hive 来看一下它的执行器和存储引擎。严格来说，Hive 并不是一个数据库，它只是一个执行器，它的存储引擎就是 HDFS 加上 Map-Reduce。在 Hive 中，一条 SQL 的执行过程是和 MySQL 差不多的，Hive 会解析 SQL，生成并优化逻辑执行计划，然后它就会把逻辑执行计划交给 Map-Reduce 去执行了，后续生成并优化物理执行计划，在 HDFS 上执行查询这些事儿，都是 Map-Reduce 去干的。顺便说一下，Hive 的执行引擎（严格来说是物理执行引擎）是可以替换的，所以就有了 Hive on Spark，Hive on Tez 这些。")])])}
var staticRenderFns = []



/***/ })

}]);
//# sourceMappingURL=109.b441cc01.js.map