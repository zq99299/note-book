(window.webpackJsonp=window.webpackJsonp||[]).push([[236],{1388:function(s,n,a){s.exports=a.p+"assets/img/image-20200715131405149.1fbf837b.png"},2140:function(s,n,a){"use strict";a.r(n);var t=a(13),e=Object(t.a)({},(function(){var s=this,n=s.$createElement,t=s._self._c||n;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"nginx-lua-webhook-自动化部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#nginx-lua-webhook-自动化部署"}},[s._v("#")]),s._v(" nginx + lua + webhook 自动化部署")]),s._v(" "),t("p",[s._v("如果将 vuepress build 之后的静态网站部署在自己的服务器上，这里有一个自动化方案，思路如下：")]),s._v(" "),t("ol",[t("li",[s._v("在 linux 服务器上安装 node、yarn、git、nginx 软件")]),s._v(" "),t("li",[s._v("编写一个脚本：用于更新 git 仓库项目，然后 build，再复制到 nginx 配置访问的文件位置")]),s._v(" "),t("li",[s._v("使用 nginx 来作为静态网站的容器")]),s._v(" "),t("li",[s._v("使用 nginx lua 模块提供一个调用脚本的入口")]),s._v(" "),t("li",[s._v("在 github 上填写 webhook 地址为，调用脚本的入口地址")]),s._v(" "),t("li",[s._v("达到：上传到 github 后，触发 webhook 事件，服务器自动构建并发布新笔记内容的功能")])]),s._v(" "),t("h2",{attrs:{id:"安装-openresty-lua-相关依赖包"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装-openresty-lua-相关依赖包"}},[s._v("#")]),s._v(" 安装 OpenResty + lua 相关依赖包")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://zq99299.github.io/note-book/cache-pdp/052.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("安装 OpenResty 和 lua 入门请参考本文章"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("请按该文章完成安装后，并完成  hello world lua 的测试，再继续下面的步骤")]),s._v(" "),t("h2",{attrs:{id:"nginx-执行-shell-脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#nginx-执行-shell-脚本"}},[s._v("#")]),s._v(" nginx 执行 shell 脚本")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://blog.csdn.net/weixin_40429878/article/details/81908019",target:"_blank",rel:"noopener noreferrer"}},[s._v("本节内容参考文章"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("要在 nginx 下执行 shell 脚本，主要使用以下两个软件：")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("lua-resty-shell")]),s._v(" 模块")]),s._v(" "),t("li",[t("strong",[s._v("sockproc")])])]),s._v(" "),t("p",[s._v("lua-resty-shell 通过 sockproc 去执行 shell 命令，并返回执行结果")]),s._v(" "),t("h3",{attrs:{id:"安装-sockproc"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装-sockproc"}},[s._v("#")]),s._v(" 安装 sockproc")]),s._v(" "),t("p",[s._v("随意把 sockproc 安装在哪里，按你自己的习惯，只要能运行上就行")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[s._v("git clone https"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("github"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("juce"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("sockproc\ncd sockproc\nmake\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("/sockproc "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("tmp"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("shell"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sock\nchmod "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0666")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("tmp"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("shell"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sock\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("sockproc 是一个服务器程序，侦测 unix socket 或者 tcp socket ， 并把收到的命令，传递给子进程执行，执行完毕后，把结果返回给客户端,，我们就让 sockproc 侦测 "),t("code",[s._v("/tmp/shell.sock")]),s._v(" 的套接口有没有数据到来。")]),s._v(" "),t("h3",{attrs:{id:"安装-lua-resty-shell-模块"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装-lua-resty-shell-模块"}},[s._v("#")]),s._v(" 安装 lua-resty-shell 模块")]),s._v(" "),t("p",[s._v("它是一个很小的库，配合 openresty 使用，目的是提供类似于 os.execute 或 io.popen 的功能， 唯一区别它是非阻塞的，也就是说即使需要耗时很久的命令，你也可以使用它")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 同样，在任意目录下，这里我们需要拿到仓库里面的 shell.lua 文件而已")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/juce/lua-resty-shell\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" lua-resty-shell\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 把 shell.lua 文件复制到 openResty 中配置的 lualib 目录中")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果是按照上面教程安装的，那么我们的 lualib路径就如下")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /usr/servers/lualib/resty/\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" lib/resty/shell.lua /usr/servers/lualib/resty/ \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("h3",{attrs:{id:"测试执行-shell-脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#测试执行-shell-脚本"}},[s._v("#")]),s._v(" 测试执行 shell 脚本")]),s._v(" "),t("p",[s._v("创建一个 lua 脚本文件")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /usr/servers/nginx/conf/test.lua\n\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" shell "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" require "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resty.shell"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" args "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    socket "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"unix:/tmp/shell.sock"')]),s._v(",  -- 这是第一步的 unxi socket\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" status, out, err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" shell.execute"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ls"')]),s._v(", args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  -- "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" 是想调用的命令,\nngx.header.content_type "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"text/plain"')]),s._v("\nngx.say"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Result:'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(" out"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("                    -- 命令输出结果\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("修改 nginx 配置")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /usr/servers/nginx/conf/lua.conf \n\nserver "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("  \n    listen       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9300")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  \n    server_name  _"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    \n    location /lua "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("  \n      default_type "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'text/html'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  \n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# content_by_lua 'ngx.say(\"hello world\")';  ")]),s._v("\n      content_by_lua_file /usr/servers/nginx/conf/test.lua"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("  \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("重新加载 nginx 配置文件后，访问 9300 端口，就可以看到 ls 命令执行后输出的内容了")]),s._v(" "),t("h2",{attrs:{id:"编写接受-webhook-的逻辑-lua-脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#编写接受-webhook-的逻辑-lua-脚本"}},[s._v("#")]),s._v(" 编写接受 webhook 的逻辑 lua 脚本")]),s._v(" "),t("p",[s._v("我们的这里的思路简单一点：")]),s._v(" "),t("ol",[t("li",[s._v("提供一个访问地址，接受 webhook 请求，请求的时候需要携带一个 token 参数")]),s._v(" "),t("li",[s._v("在 lua 脚本中获取这个 token 参数，并校验是否自己设置的，如果不是，则直接丢弃这个请求")]),s._v(" "),t("li",[s._v("执行笔记构建部署脚本")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("-- 拿一个地址来说明：http://eshop-cache03/lua?method"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("hello"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("productId")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n-- 获取问号后面的参数列表\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" uri_args "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx.req.get_uri_args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n-- 获取参数\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" token "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" uri_args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"token"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" checkToken "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"123456xxx"')]),s._v("\n\n-- 如果没有提供 token 则输出一个 err 信息\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" not token "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("  \n    ngx.say"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"request error :"')]),s._v(", err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  \n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v("  \nend\n\n-- 判断是否与 token 相等\nif"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" token "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" checkToken "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    ngx.say"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"request error :"')]),s._v(", err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  \n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v("  \nend\n\n-- 校验通过后，执行脚本\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" shell "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" require "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resty.shell"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" args "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    socket "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"unix:/tmp/shell.sock"')]),s._v(", \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" status, out, err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" shell.execute"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sh /xx/build.sh"')]),s._v(", args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  \nngx.header.content_type "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"text/plain"')]),s._v("\nngx.say"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Result:'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(" out"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br")])]),t("p",[s._v("那么这个 "),t("code",[s._v("/xx/build.sh")]),s._v(" 内容经过测试有如下的特性")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[s._v("#"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("bin"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("bash\nll\ntouch "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("servers"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("nginx"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("conf"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("testxxxxxxxxx\necho "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Hello World !"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("命令会正常执行，但是只会输出  echo 打印的信息给调用处。")]),s._v(" "),t("p",[s._v("前面验证了我们方案中的关键部分 "),t("strong",[s._v("lua 执行 sh 脚本")]),s._v("，下面就开始真正实现自动构建")]),s._v(" "),t("h2",{attrs:{id:"vuepress-自动构建"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#vuepress-自动构建"}},[s._v("#")]),s._v(" vuepress 自动构建")]),s._v(" "),t("p",[s._v("步骤如下：")]),s._v(" "),t("ul",[t("li",[s._v("安装 vuepress build 的软件环境："),t("a",{attrs:{href:"https://yarn.bootcss.com/docs/install/#centos-stable",target:"_blank",rel:"noopener noreferrer"}},[s._v("yarn"),t("OutboundLink")],1),s._v(" 和 "),t("a",{attrs:{href:"https://github.com/zq99299/essay-note/blob/master/chapter/linux/install.md#node",target:"_blank",rel:"noopener noreferrer"}},[s._v("node"),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"https://zq99299.github.io/note-book/posts/linux/git.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("安装 git 软件"),t("OutboundLink")],1),s._v("：用于克隆一个项目到本地，进行拉取最新的笔记内容")]),s._v(" "),t("li",[s._v("编写构建脚本")]),s._v(" "),t("li",[s._v("配置 nginx 访问构建好的静态网站")]),s._v(" "),t("li",[s._v("在 Github 对应项目配置 webhook 地址到我们提供的 lua 入口")])]),s._v(" "),t("h3",{attrs:{id:"clone-项目"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#clone-项目"}},[s._v("#")]),s._v(" clone 项目")]),s._v(" "),t("p",[s._v("把要自动部署构建的项目 clone 下来。我们的构建和发布目录都在 "),t("code",[s._v("/usr/servers/notework/")]),s._v(" 目录下展开")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /usr/servers/notework/gitrepo\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /usr/servers/notework/gitrepo\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 在该路径下存放我们的笔记项目")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/zq99299/mysql-tutorial.git\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/zq99299/note-book.git\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/zq99299/java-tutorial.git\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/zq99299/linux-tutorial.git\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/zq99299/mq-tutorial.git\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/zq99299/dsalg-tutorial.git\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("h3",{attrs:{id:"编写构建脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#编写构建脚本"}},[s._v("#")]),s._v(" 编写构建脚本")]),s._v(" "),t("p",[s._v("这是一个公共的构建脚本，在调用该脚本的时候，需要把项目名传递进来")]),s._v(" "),t("p",[t("code",[s._v("/usr/servers/notework/build.sh")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/sh")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一个工作目录，用于存放仓库、打包后部署目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("noteworkDir")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/servers/notework\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 笔记仓库名称，每个笔记一个，调用脚本时，将项目名传递进来")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("noteName")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 更新项目，并构建")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$noteworkDir")]),s._v("/gitrepo/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$noteName")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" pull\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" docs:build\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除构建好的包，并用新的覆盖")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -rf "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$noteworkDir")]),s._v("/release/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$noteName")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$noteworkDir")]),s._v("/release/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$noteName")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" build/.vuepress/dist/* "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$noteworkDir")]),s._v("/release/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$noteName")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("p",[s._v("配置 nginx 访问构建好的静态网站")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("server {\n    listen       80;\n    server_name  localhost;\n\n    charset utf-8; \n\n    #access_log  logs/host.access.log  main;\n\n    location ^~ /linux-tutorial {\n        # root   /usr/servers/notework/release/linux-tutorial/;\n        alias /usr/servers/notework/release/linux-tutorial/;\n    }\n}\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("需要说明下的是：这里的 location 的配置，这个需要看你的 "),t("code",[s._v("docs/.vuepress/config.js")]),s._v(" 中 bash 的设置，由于要部署到 githubio，这里使用了一个前缀路径。")]),s._v(" "),t("p",[s._v("现在，可以通过 "),t("code",[s._v("http://你的主机 IP/linux-tutorial/")]),s._v(" 访问到这个项目了。")]),s._v(" "),t("h3",{attrs:{id:"编写-lua-脚本自动构建逻辑"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#编写-lua-脚本自动构建逻辑"}},[s._v("#")]),s._v(" 编写 lua 脚本自动构建逻辑")]),s._v(" "),t("p",[s._v("前面写了一部分，这里做一点修改")]),s._v(" "),t("p",[t("code",[s._v("/usr/servers/nginx/conf/noteBuild.lua")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("-- 拿一个地址来说明：http://eshop-cache03/lua?method"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("hello"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("productId")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n-- 获取问号后面的参数列表\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" uri_args "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx.req.get_uri_args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n-- 获取参数\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" token "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" uri_args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"token"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n-- 这里增加一个 noteName 的参数值，需要 webhook 中回调，来构建不同的项目\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" noteName "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" uri_args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"noteName"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" checkToken "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"123456xxx"')]),s._v("\n\n-- 如果没有提供 token 则输出一个 err 信息\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" not token "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("  \n    ngx.say"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"request error token is null:"')]),s._v(", err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  \n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v("  \nend\n\n-- 判断是否与 token 相等\nif"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" token ~"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" checkToken "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    ngx.say"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"request error token mismatching:"')]),s._v(", err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  \n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v("  \nend\n\n-- 检查当前笔记是否支持自动构建\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" not noteName "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("  \n    ngx.say"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"request error noteName is null:"')]),s._v(", err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  \n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v("  \nend\n\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" supportNotes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"linux-tutorial"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mysql-tutorial"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v("  isInTable"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("value,list"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" not list "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("   \n   end \n   "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" k, "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("v")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" pairs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("list"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("v")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" value "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n\t  "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n\tend\n   end\nend \nif"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" not isInTable"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("noteName,supportNotes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    ngx.say"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"request error noteName mismatching:"')]),s._v(", err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  \n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v("  \nend\n\n-- 校验通过后，执行脚本\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" shell "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" require "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resty.shell"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" args "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    socket "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"unix:/tmp/shell.sock"')]),s._v(", \n\t"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("120000")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n-- 不加 nohub "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v("秒回执行超时，加了之后，貌似受上面的 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" 控制，不明白这一块是啥原因\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" exeStr "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nohub sh /usr/servers/notework/build.sh "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("noteName\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" status, out, err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" shell.execute"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("exeStr, args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx.header.content_type "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"text/plain"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" out "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n ngx.say"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Result:'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(" out"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \n "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v("\nend\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" err "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n ngx.say"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Result:'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(" err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \n "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v("\nend\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br"),t("span",{staticClass:"line-number"},[s._v("63")]),t("br"),t("span",{staticClass:"line-number"},[s._v("64")]),t("br")])]),t("p",[t("code",[s._v("/usr/servers/nginx/conf/noteBuild.conf")])]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[s._v("server "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    listen       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  \n    server_name  _"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    charset utf"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  # 中文不乱码\n    \n    location "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("lua "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("  \n      default_type "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'text/html'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  \n      # content_by_lua "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ngx.say(\"hello world\")'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  \n      content_by_lua_file "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("servers"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("nginx"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("conf"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("noteBuild"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("lua"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("同样需要在 nginx.conf 中引用这个 noteBuild.conf 文件")]),s._v(" "),t("p",[t("strong",[s._v("注意：")]),s._v(" 这里的 conf 中的监听端口不能与前面配置访问静态文件的端口一致，一致的话，前面的配置将被覆盖，同样可以将调用脚本的这代码与前面访问静态文件的配置在同一个 server 中，就不会出现这种问题了")]),s._v(" "),t("p",[s._v("配置完成之后可以简单测试下，访问地址 "),t("code",[s._v("http://你的 ip/lua?token=123456xxx&noteName=linux-tutorial")]),s._v("，比如这个 linux-tutorial 整个构建响应信息如下")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('Result:\nAlready up to date.\nyarn install v1.22.4\n[1/4] Resolving packages...\nsuccess Already up-to-date.\nDone in 1.11s.\nyarn run v1.22.4\n$ vuepress build docs\nwait Extracting site metadata...\ntip Apply theme @vuepress/theme-default ...\ntip Apply plugin container (i.e. "vuepress-plugin-container") ...\ntip Apply plugin @vuepress/register-components (i.e. "@vuepress/plugin-register-components") ...\ntip Apply plugin @vuepress/active-header-links (i.e. "@vuepress/plugin-active-header-links") ...\ntip Apply plugin @vuepress/nprogress (i.e. "@vuepress/plugin-nprogress") ...\ntip Apply plugin smooth-scroll (i.e. "vuepress-plugin-smooth-scroll") ...\ntip Apply plugin @vuepress/back-to-top (i.e. "@vuepress/plugin-back-to-top") ...\ntip Apply plugin @vuepress/pwa (i.e. "@vuepress/plugin-pwa") ...\ntip Apply plugin @vuepress/medium-zoom (i.e. "@vuepress/plugin-medium-zoom") ...\ntip Apply plugin @vuepress/search (i.e. "@vuepress/plugin-search") ...\ntip Apply plugin @vssue/vssue (i.e. "@vssue/vuepress-plugin-vssue") ...\ntip Apply plugin code-copy (i.e. "vuepress-plugin-code-copy") ...\ntip Apply plugin @vuepress/last-updated (i.e. "@vuepress/plugin-last-updated") ...\ntip Apply plugin baidu-tongji-analytics (i.e. "vuepress-plugin-baidu-tongji-analytics") ...\ntip Apply plugin baidu-autopush (i.e. "vuepress-plugin-baidu-autopush") ...\nℹ Compiling Client\nℹ Compiling Server\n✔ Server: Compiled successfully in 53.18s\n✔ Client: Compiled successfully in 53.67s\nwait Rendering static HTML...\n[2K[1Gwait Generating service worker...\nsuccess Generated static files in build/.vuepress/dist.\n\nDone in 80.58s.\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br")])]),t("h3",{attrs:{id:"配置-github-webhook-地址"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置-github-webhook-地址"}},[s._v("#")]),s._v(" 配置 github webhook 地址")]),s._v(" "),t("p",[t("img",{attrs:{src:a(1388),alt:"image-20200715131405149"}})]),s._v(" "),t("p",[s._v("关于上图中的 URL，换成你自己的 IP 和开放的端口，还有各种参数。")]),s._v(" "),t("p",[s._v("之后就可以测试下，往 gitHub 上 push 一个文档的修改，看是否能触发自动构建。")]),s._v(" "),t("h2",{attrs:{id:"配置自定义域名"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置自定义域名"}},[s._v("#")]),s._v(" 配置自定义域名")]),s._v(" "),t("p",[s._v("本人的 DNS 在万网，完全的网址重定向，只能在万网的机器才可以，所以只能使用转发到一个 IP 上，所以笔记访问端口就只能是 80 端口了，其他的端口不支持配置。")]),s._v(" "),t("p",[s._v("下面是修改后的配置")]),s._v(" "),t("p",[t("code",[s._v("/usr/servers/nginx/conf/nginx.conf")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('worker_processes  1;\n\n#error_log  logs/error.log;\n#error_log  logs/error.log  notice;\n#error_log  logs/error.log  info;\n\n#pid        logs/nginx.pid;\n\n\nevents {\n    worker_connections  1024;\n}\n\n\nhttp {\n    lua_package_path "/usr/servers/lualib/?.lua;;";  \n    lua_package_cpath "/usr/servers/lualib/?.so;;"; \n    # include noteBuild.conf; \n    include       mime.types;\n    default_type  application/octet-stream;\n\n    #log_format  main  \'$remote_addr - $remote_user [$time_local] "$request" \'\n    #                  \'$status $body_bytes_sent "$http_referer" \'\n    #                  \'"$http_user_agent" "$http_x_forwarded_for"\';\n\n    #access_log  logs/access.log  main;\n\n    sendfile        on;\n    #tcp_nopush     on;\n\n    #keepalive_timeout  0;\n    keepalive_timeout  65;\n\n    #gzip  on;\n\n    server {\n        listen       80;\n        server_name  _;\n\n        #charset koi8-r;\n\n        #access_log  logs/host.access.log  main;\n        \n        # 将 github webhook 调用的入口移动到这里来了，公用一个域名\n        location /note-auto-build {  \n          default_type \'text/html\';    \n          content_by_lua_file /usr/servers/nginx/conf/noteBuild.lua;\n        } \n\n        # 有几个笔记项目就写几个指向\n        location ^~ /linux-tutorial {\n          alias /usr/servers/notework/release/linux-tutorial/;\n        }\n    }\n    \n    # 这个是针对不同域名的配置\n    # 我这里给每一个笔记项目都配置了一个二级域名\n    server {\n      server_name linux-tutorial.mrcode.cn;\n      listen 80;\n      # 这个是能访问到 index.html 文件\n      location / {\n          alias /usr/servers/notework/release/linux-tutorial/;\n      }\n      # 这里是兼容有前缀的 css 等资源下载，由于我们的 .vuepress/config.js base 中配置了前缀\n      # 要同时兼容能推送到 githubio 上，这里就只能这样曲线救国了\n      # 实现的效果就是访问 inux-tutorial.mrcode.cn ,就能正常阅读\n      location ^~ /linux-tutorial {\n          alias /usr/servers/notework/release/linux-tutorial/;\n      }\n    }\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br"),t("span",{staticClass:"line-number"},[s._v("63")]),t("br"),t("span",{staticClass:"line-number"},[s._v("64")]),t("br"),t("span",{staticClass:"line-number"},[s._v("65")]),t("br"),t("span",{staticClass:"line-number"},[s._v("66")]),t("br"),t("span",{staticClass:"line-number"},[s._v("67")]),t("br"),t("span",{staticClass:"line-number"},[s._v("68")]),t("br"),t("span",{staticClass:"line-number"},[s._v("69")]),t("br"),t("span",{staticClass:"line-number"},[s._v("70")]),t("br"),t("span",{staticClass:"line-number"},[s._v("71")]),t("br"),t("span",{staticClass:"line-number"},[s._v("72")]),t("br")])]),t("p",[s._v("关于上面的配置，按照你自己的需求来组织是否给二级域名，还是一个域名就全部搞定")])])}),[],!1,null,null,null);n.default=e.exports}}]);